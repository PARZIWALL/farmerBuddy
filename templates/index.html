<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krishi Form Filler - AI-Powered Agricultural Form Assistant</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        .hero-section {
            background: linear-gradient(135deg, #28a745, #218838);
            color: white;
            padding: 4rem 0;
        }
        .feature-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            height: 100%;
            border: 1px solid #ddd;
        }
        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .scheme-badge {
            font-size: 0.8rem;
        }
        /* small upload result styling */
        #uploadResult .text-monospace {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
        }
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(255,255,255,0.2);
            border-top-color: rgba(255,255,255,0.9);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            vertical-align: middle;
            margin-left: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}"><i class="fas fa-seedling"></i> Krishi Form Filler</a>
            <div class="navbar-nav ml-auto">
                <span class="navbar-text">AI-Powered Agricultural Assistant</span>
            </div>
        </div>
    </nav>

    <div class="hero-section">
        <div class="container text-center">
            <h1 class="display-4 mb-4"><i class="fas fa-tractor"></i> Krishi Form Filler</h1>
            <p class="lead">Your intelligent assistant for filling out agricultural scheme applications with RAG-powered AI</p>
            <p class="mb-4">Save time and reduce errors. Let AI handle the paperwork.</p>
        </div>
    </div>

    <div class="container mt-5">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Upload Documents Section -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h4 class="card-title text-center">
                        <i class="fas fa-upload text-success"></i> Upload Your Documents
                    </h4>
                    <p class="text-center text-muted mb-4">
                        Store your documents securely in our system. Use Aadhaar or a system-generated User ID to link them.
                    </p>

                    <form id="uploadForm" enctype="multipart/form-data" novalidate>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="aadhaar"><i class="fas fa-id-card"></i> Aadhaar Number (Optional)</label>
                                <input type="text" class="form-control" id="aadhaar" name="aadhaar" placeholder="Enter Aadhaar number">
                                <small class="form-text text-muted">Leave blank if using auto-generated User ID</small>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="user_id"><i class="fas fa-user"></i> User ID (Optional)</label>
                                <input type="text" class="form-control" id="user_id" name="user_id" placeholder="Enter User ID if known">
                                <small class="form-text text-muted">If Aadhaar is not provided, a new User ID will be generated.</small>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="scheme"><i class="fas fa-seedling"></i> Select Scheme</label>
                            <select class="form-control" id="scheme" name="scheme" required>
                                {% for scheme_id, scheme_info in schemes.items() %}
                                    <option value="{{ scheme_id }}">{{ scheme_info.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="documents"><i class="fas fa-file-alt"></i> Select Documents</label>
                            <input type="file" class="form-control-file" id="documents" name="documents" multiple required>
                            <small class="form-text text-muted">Supported: PDF, DOCX, JPG, PNG</small>
                        </div>

                        <div class="text-center mt-4">
                            <button id="uploadBtn" type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-cloud-upload-alt"></i> Upload Documents
                            </button>
                        </div>
                    </form>

                    <!-- Result Display -->
                    <div id="uploadResult" class="mt-4" style="display:none;">
                        <div class="alert alert-success">
                            <h5><i class="fas fa-check-circle"></i> Upload Successful</h5>
                            <p id="resultMessage"></p>
                            <p><strong>User ID:</strong> <span id="resultUserId" class="text-monospace"></span></p>
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-primary btn-sm" id="copyUserBtn">
                                    <i class="fas fa-copy"></i> Copy User ID
                                </button>
                                <a id="proceedAutoFill" class="btn btn-warning btn-sm" href="#">
                                    <i class="fas fa-magic"></i> Proceed to Auto Fill
                                </a>
                                <button class="btn btn-secondary btn-sm" id="showFilesBtn">
                                    <i class="fas fa-file"></i> Show Uploaded Files
                                </button>
                            </div>
                            <div id="filesList" class="mt-3" style="display:none;">
                                <h6>Uploaded files:</h6>
                                <ul id="filesUl"></ul>
                            </div>
                        </div>
                    </div>

                    <!-- Error display -->
                    <div id="uploadError" class="mt-4" style="display:none;">
                        <div class="alert alert-danger" id="uploadErrorText"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <div class="row mt-5">
            <div class="col-md-6 mb-4">
                <div class="card feature-card shadow-sm">
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <i class="fas fa-robot fa-3x text-primary"></i>
                        </div>
                        <h5 class="card-title text-center">Automated Form Filling <span class="badge badge-primary scheme-badge">RAG-Powered</span></h5>
                        <p class="card-text">Select a government scheme, upload your documents (Aadhaar, Bank Passbook, etc.), and our AI will automatically fill the official application form for you.</p>
                        
                        <div class="mt-3">
                            <h6><i class="fas fa-check-circle text-success"></i> Available Schemes:</h6>
                            <ul class="small">
                                {% for scheme_id, scheme_info in schemes.items() %}
                                <li>{{ scheme_info.name }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        
                        <div class="text-center mt-4">
                            <a href="{{ url_for('auto_fill_user') }}" class="btn btn-primary btn-lg">
                                <i class="fas fa-magic"></i> Start Automated Fill
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="card feature-card shadow-sm">
                    <div class="card-body">
                        <div class="text-center mb-3">
                            <i class="fas fa-edit fa-3x text-secondary"></i>
                        </div>
                        <h5 class="card-title text-center">Manual Form Filling</h5>
                        <p class="card-text">Have a different form? Upload any DOCX application, and our AI will identify the fields. You can then fill them in, with optional AI assistance from your documents.</p>
                        
                        <div class="mt-3">
                            <h6><i class="fas fa-file-word text-primary"></i> What you need:</h6>
                            <ul class="small">
                                <li>Your blank application form in DOCX format.</li>
                                <li>(Optional) Your supporting documents for AI pre-filling.</li>
                            </ul>
                        </div>
                        
                        <div class="text-center mt-4">
                            <a href="{{ url_for('manual_fill') }}" class="btn btn-secondary btn-lg">
                                <i class="fas fa-file-upload"></i> Start Manual Fill
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-5">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body">
                        <h5 class="card-title"><i class="fas fa-info-circle"></i> How It Works</h5>
                        <div class="row">
                            <div class="col-md-4 text-center">
                                <i class="fas fa-upload fa-2x text-success mb-2"></i>
                                <h6>1. Upload Documents</h6>
                                <p class="small">Upload your forms and documents in any supported format (PDF, JPG, DOCX).</p>
                            </div>
                            <div class="col-md-4 text-center">
                                <i class="fas fa-brain fa-2x text-info mb-2"></i>
                                <h6>2. AI Processing</h6>
                                <p class="small">Our RAG-powered AI scans and extracts relevant information from your documents.</p>
                            </div>
                            <div class="col-md-4 text-center">
                                <i class="fas fa-download fa-2x text-warning mb-2"></i>
                                <h6>3. Download Form</h6>
                                <p class="small">Get your filled application form, ready for submission.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-dark text-white mt-5 py-4">
        <div class="container text-center">
            <p>&copy; 2025 Krishi Form Filler. Empowering farmers with AI technology.</p>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>

    <script>
    // Intercept upload form and POST via AJAX, then show user_id result
    $(function(){
        const $form = $("#uploadForm");
        const $btn = $("#uploadBtn");
        const $result = $("#uploadResult");
        const $resultMsg = $("#resultMessage");
        const $resultUser = $("#resultUserId");
        const $filesUl = $("#filesUl");
        const $filesList = $("#filesList");
        const $showFilesBtn = $("#showFilesBtn");
        const $errorDiv = $("#uploadError");
        const $errorText = $("#uploadErrorText");

        $form.on("submit", function(e){
            e.preventDefault();
            $errorDiv.hide();
            $result.hide();
            $filesList.hide();
            $filesUl.empty();

            const fd = new FormData(this);
            // get input files
            const input = document.getElementById('documents');
            if (!input.files || input.files.length === 0) {
                $errorText.text("Please select at least one document to upload.");
                $errorDiv.show();
                return;
            }
            // disable button and show spinner
            $btn.prop('disabled', true);
            const origHtml = $btn.html();
            $btn.html('<i class="fas fa-cloud-upload-alt"></i> Uploading <span class="loading-spinner"></span>');

            $.ajax({
                url: "{{ url_for('ingest_documents') }}",
                type: "POST",
                data: fd,
                contentType: false,
                processData: false,
                success: function(resp){
                    // resp expected: { message, user_id, files_saved }
                    $btn.prop('disabled', false).html(origHtml);
                    $resultMsg.text(resp.message || "Uploaded successfully.");
                    $resultUser.text(resp.user_id || "");
                    $filesUl.empty();
                    if (resp.files_saved && resp.files_saved.length) {
                        resp.files_saved.forEach(function(fname){
                            $filesUl.append($("<li>").text(fname));
                        });
                        $filesList.show();
                    } else {
                        $filesList.hide();
                    }
                    // set proceed link to auto_fill page with query param user_id
                    $("#proceedAutoFill").attr("href", "{{ url_for('auto_fill_user') }}" + "?user_id=" + encodeURIComponent(resp.user_id || ""));
                    $result.show();
                },
                error: function(xhr){
                    $btn.prop('disabled', false).html(origHtml);
                    const err = (xhr.responseJSON && (xhr.responseJSON.error || xhr.responseJSON.message)) || xhr.statusText || "Upload failed";
                    $errorText.text("Upload error: " + err);
                    $errorDiv.show();
                    console.error(xhr);
                }
            });
        });

        $("#copyUserBtn").on("click", function(){
            const v = $resultUser.text().trim();
            if (!v) return alert("No user id to copy.");
            navigator.clipboard.writeText(v).then(function(){
                alert("User ID copied to clipboard!");
            });
        });

        $showFilesBtn.on("click", function(){
            $filesList.toggle();
        });
    });
    </script>
</body>
</html>
